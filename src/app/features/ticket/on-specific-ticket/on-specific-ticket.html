<div *ngIf="loading" class="loading-txt">Loading...</div>

<div class="ticket-layout" *ngIf="!loading && ticket">

  <div class="main-column">
    
    <div class="ticket-header">
      <div class="header-top">
        <span class="ticket-id">#{{ ticket.ticketId }}</span>
        <span class="status-badge" [ngClass]="'status-' + ticket.status">
          {{ ticket.status.replace('_', ' ') }}
        </span>
      </div>
      <h2 class="ticket-title">{{ ticket.title }}</h2>
      <div class="description-box">{{ ticket.description }}</div>
    </div>

    <div class="chat-container">
      
      <div class="chat-messages" #scrollContainer>
        <div *ngIf="comments.length === 0" style="text-align:center; color:#999; margin-top:20px;">
          No messages yet.
        </div>

        <ng-container *ngFor="let c of comments">
          <div class="message-wrapper" 
               *ngIf="!c.internal || isAgent"
               [ngClass]="(c.user === currentUserEmail || c.user === 'You') ? 'right' : 'left'">
            
            <div class="message-meta">
              {{ c.user }} â€¢ {{ c.createdAt | date:'shortTime' }}
            </div>

            <div class="message-wrapper-inner" [ngClass]="{'internal-note': c.internal}">
              <div class="message-bubble">
                {{ c.text }}
              </div>
            </div>

          </div>
        </ng-container>

      </div>

      <div class="chat-input-area">
        
        <div *ngIf="ticket.status === 'CLOSED'" class="closed-alert">
          Ticket is closed.
        </div>

        <div *ngIf="ticket.status !== 'CLOSED'">
          <textarea [(ngModel)]="commentText" placeholder="Write a message..." rows="3"></textarea>
          
          <div class="input-actions">
            <div *ngIf="isAgent">
              <label style="font-size:13px; color:#666;">
                <input type="checkbox" [(ngModel)]="isInternal"> Internal Note
              </label>
            </div>
            <div *ngIf="!isAgent"></div> 
            <button class="btn-send" (click)="addComment()">
             <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <aside class="sidebar-column">

    <div class="sidebar-card" *ngIf="isAgent || isManagerOrAdmin">
      <div class="sidebar-title">Actions</div>
      
      <button *ngIf="isAgent" class="btn-action" (click)="openStatusModal()">
        Change Status
      </button>

      <ng-container *ngIf="isManagerOrAdmin">
        <button *ngIf="!ticket.assignedAgentId" class="btn-action" (click)="assignTicket(ticket.ticketId)">
          Assign Agent
        </button>
        <button *ngIf="ticket.assignedAgentId" class="btn-action" (click)="reassignTicket(ticket.ticketId)">
          Reassign Agent
        </button>
      </ng-container>

         
      <button
  *ngIf="showStartWorking()"
  class="btn-action"
  (click)="startWorking()">
  <i class="fas fa-play" style="margin-right: 6px;"></i> Start Working
</button>
<button
  *ngIf="showCloseTicket()"
  class="btn-action danger"
  (click)="closeTicket()">
  <i class="fas fa-times" style="margin-right: 6px;"></i> Close Ticket
</button>
    </div>

    <div class="sidebar-card">
      <div class="sidebar-title">Details</div>
      <div class="info-row">
        <span>Category</span> <span>{{ ticket.category }}</span>
      </div>
      <div class="info-row">
        <span>Priority</span> <span>{{ ticket.priority }}</span>
      </div>
      <div class="info-row">
        <span>Created</span> <span>{{ ticket.createdAt | date:'shortDate' }}</span>
      </div>
      <div class="info-row">
        <span>Agent</span> <span>{{ ticket.assignedAgentId || 'Unassigned' }}</span>
      </div>
    </div>

    <div class="sidebar-card">
      <div class="sidebar-title">Attachments</div>
      <div *ngIf="attachments.length === 0" style="color:#999; font-size:13px;">None</div>
      <div *ngFor="let file of attachments" style="font-size:13px; margin-bottom:5px;">
        <a href="javascript:void(0)" (click)="downloadFile(file)" style="color:#007bff; text-decoration:none;">
          {{ file.fileName }}
        </a>
      </div>
    </div>

  </aside>
</div>

<div class="modal-overlay" *ngIf="showStatusModal">
  <div class="modal-content">
    <h3 style="margin-top:0;">Update Status</h3>
    <p style="font-size:14px; color:#666;">Select new status:</p>
    
    <select [(ngModel)]="selectedStatus" class="modal-select">
      <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
    </select>

    <div class="modal-actions">
      <button class="btn-cancel" (click)="closeStatusModal()">Cancel</button>
      <button class="btn-confirm" (click)="confirmStatusChange()">Save</button>
    </div>
  </div>
</div>